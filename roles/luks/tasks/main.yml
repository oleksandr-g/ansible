- name: Copy keyfile onto machine
  copy:
    src: keyfile
    dest: /root/keyfile
    owner: root
    group: root
    mode: 0400

- name: Create LUKS container (remains unchanged if it already exists)
  community.crypto.luks_device:
    device: /dev/disk/by-uuid/504e04e6-8f87-4770-a655-0edb3e84d3a4
    state: present
    keyfile: /root/keyfile

- name: Create a ext3 filesystem on disk
  filesystem:
    fstype: ext3
    dev: /dev/disk/by-uuid/504e04e6-8f87-4770-a655-0edb3e84d3a4

- name: Add the below lines to crypttab
  blockinfile:
    path: /etc/crypttab
    state: present
    block: |
      sda_crypt      /dev/disk/by-uuid/504e04e6-8f87-4770-a655-0edb3e84d3a4  /root/keyfile  luks

- name: Create a directory for mounting if it does not exist
  ansible.builtin.file:
    path: /crypted
    state: directory
    mode: '0755'

- name: Add the below lines to fstab
  blockinfile:
    path: /etc/fstab
    state: present
    block: |
      /dev/mapper/sda_crypt  /crypted     ext3    nofail,x-systemd.device-timeout=1ms        0       2